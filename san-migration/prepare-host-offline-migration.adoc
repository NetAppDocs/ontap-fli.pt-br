---
permalink: san-migration/prepare-host-offline-migration.html 
sidebar: sidebar 
keywords: prepare, hosts, fli, offline, migration 
summary: Antes de iniciar uma migração offline do FLI, você deve executar todas as etapas necessárias para a correção do host; depois, você deve reinicializar seus hosts e verificar se o multipathing do host está configurado corretamente. 
---
= Preparar hosts para migração offline do ONTAP FLI
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
Antes de iniciar uma migração offline de Importação de LUN Estrangeiro (FLI), você deve executar todas as etapas identificadas na fase de análise como necessárias para a correção do host, como a instalação de kits de conexão de host ou DSMs. Você também deve reinicializar seus hosts e verificar se o multipathing do host está configurado corretamente.

.Passos
. Execute todas as etapas de correção do host necessárias identificadas no link:concept_migration_analyze_phase_workflow.html["fase de análise"] .
. Encerre todas as suas aplicações abertas.
. Reinicie o host.
. Revise os logs para ver se há erros.
. Verifique a configuração de multicaminhos do seu host.
+
** Para hosts Windows: Consulte link:https://docs.netapp.com/us-en/ontap-sanhost/hu_windows_2022.html#multipathing["Usando o Windows Server 2022 com ONTAP"] para obter etapas sobre como verificar sua configuração de multicaminho.
** Para hosts Linux: execute o  `multipath-ll` comando e revise a saída. Todos os caminhos devem ser exibidos como ativos e prontos.
+
.Exemplo de saída do comando multipath-ll
[%collapsible]
====
mpath2 (360060e801046b96004f2bf4600000012) dm-6 HITACHI,DF600F

\_ round-robin 0 [prio=1][ativo] \_ 0:0:1:2 sdg 8:96 [ativo][pronto] \_ 1:0:1:2 sdo 8:224 [ativo][pronto] \_ round-robin 0 [prio=0][habilitado] \_ 0:0:0:2 sdc 8:32 [ativo][pronto] \_ 1:0:0:2 sdk 8:160 [ativo][pronto] mpath1 (360060e801046b96004f2bf4600000011) dm-5 HITACHI,DF600F

\_ round-robin 0 [prio=1][ativo] \_ 0:0:0:1 sdb 8:16 [ativo][pronto] \_ 1:0:0:1 sdj 8:144 [ativo][pronto] \_ round-robin 0 [prio=0][habilitado] \_ 0:0:1:1 sdf 8:80 [ativo][pronto] \_ 1:0:1:1 sdn 8:208 [ativo][pronto] mpath0 (360060e801046b96004f2bf4600000010) dm-0 HITACHI,DF600F

\_ round-robin 0 [prio=1][ativo] \_ 0:0:1:0 sde 8:64 [ativo][pronto] \_ 1:0:1:0 sdm 8:192 [ativo][pronto] \_ round-robin 0 [prio=0][habilitado] \_ 0:0:0:0 sda 8:0 [ativo][pronto] \_ 1:0:0:0 sdi 8:128 [ativo][pronto] mpath3 (360060e801046b96004f2bf4600000013) dm-7 HITACHI,DF600F

\_ round-robin 0 [prio=1][ativo] \_ 0:0:0:3 sdd 8:48 [ativo][pronto] \_ 1:0:0:3 sdl 8:176 [ativo][pronto] \_ round-robin 0 [prio=0][habilitado] \_ 0:0:1:3 sdh 8:112 [ativo][pronto] \_ 1:0:1:3 sdp 8:240 [ativo][pronto] [root@dm-rx200s6-22 ~]#

====






== Verificação multipath para hosts ESXi

Como parte do processo de importação de LUN estrangeiro (FLI), você deve verificar se o multipath está configurado e funcionando corretamente em seus hosts ESXi.

.Passos
. Determine o ESXi e a máquina virtual usando o VMware vSphere Client.
+
image::../media/esxi_host_1.png[Armazenamentos de dados de storage do vSphere]

. Determine os LUNs SAN a serem migrados usando o vSphere Client.
+
image::../media/esxi_host_2.png[Dispositivos de armazenamento vSphere]

. Determine os volumes VMFS e RDM (vfat) a serem migrados: `esxcli storage filesystem list`
+
[listing]
----
Mount Point                                        Volume Name        UUID                                 Mounted  Type           Size         Free
-------------------------------------------------  -----------------  -----------------------------------  -------  ------  -----------  -----------
/vmfs/volumes/538400f6-3486df59-52e5-00262d04d700  BootLun_datastore  538400f6-3486df59-52e5-00262d04d700     true  VMFS-5  13421772800  12486443008
/vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700  VM_datastore       53843dea-5449e4f7-88e0-00262d04d700     true  VMFS-5  42681237504   6208618496
/vmfs/volumes/538400f6-781de9f7-c321-00262d04d700                     538400f6-781de9f7-c321-00262d04d700     true  vfat     4293591040   4269670400
/vmfs/volumes/c49aad7f-afbab687-b54e-065116d72e55                     c49aad7f-afbab687-b54e-065116d72e55     true  vfat      261853184     77844480
/vmfs/volumes/270b9371-8fbedc2b-1f3b-47293e2ce0da                     270b9371-8fbedc2b-1f3b-47293e2ce0da     true  vfat      261853184    261844992
/vmfs/volumes/538400ef-647023fa-edef-00262d04d700                     538400ef-647023fa-edef-00262d04d700     true  vfat      299712512     99147776
~ #
----
+
[NOTE]
====
No caso de VMFS com extends (VMFS expandido), todos os LUNs que fazem parte do span devem ser migrados. Para mostrar todas as extensões na GUI, vá para Configuração e armazenamento de dados e clique em datastore para selecionar o link Propriedades.

====
+
[NOTE]
====
Após a migração, ao adicioná-los de volta ao armazenamento, você verá várias entradas de LUN com o mesmo rótulo VMFS. Neste cenário, deve pedir ao cliente que selecione apenas a entrada marcada como Head.

====
. Determine o LUN e o tamanho a serem migrados: `esxcfg-scsidevs -c`
+
[listing]
----
Device UID                            Device Type      Console Device                                            Size      Multipath PluginDisplay Name
mpx.vmhba36:C0:T0:L0                  CD-ROM           /vmfs/devices/cdrom/mpx.vmhba36:C0:T0:L0                  0MB       NMP     Local Optiarc CD-ROM (mpx.vmhba36:C0:T0:L0)
naa.60060e801046b96004f2bf4600000014  Direct-Access    /vmfs/devices/disks/naa.60060e801046b96004f2bf4600000014  20480MB   NMP     HITACHI Fibre Channel Disk (naa.60060e801046b96004f2bf4600000014)
naa.60060e801046b96004f2bf4600000015  Direct-Access    /vmfs/devices/disks/naa.60060e801046b96004f2bf4600000015  40960MB   NMP     HITACHI Fibre Channel Disk (naa.60060e801046b96004f2bf4600000015)
~~~~~~ Output truncated ~~~~~~~
~ #
----
. Identificar LUNs de mapeamento de dispositivos brutos (RDM) a serem migrados.
. Encontrar dispositivos RDM: `+find /vmfs/volumes -name **-rdm**+`
+
[listing]
----
/vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Windows2003/Windows2003_1-rdmp.vmdk
/vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Windows2003/Windows2003_2-rdm.vmdk
/vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Linux/Linux_1-rdm.vmdk
/vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Solaris10/Solaris10_1-rdmp.vmdk
----
. Remova -rdmp e -rdm da saída anterior e execute o comando vmkfstools para encontrar mapeamento vml e tipo RDM.
+
[listing]
----
# vmkfstools -q /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Windows2003/Windows2003_1.vmdk
vmkfstools -q /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Windows2003/Windows2003_1.vmdk
Disk /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Windows2003/Windows2003_1.vmdk is a Passthrough Raw Device Mapping
Maps to: vml.020002000060060e801046b96004f2bf4600000016444636303046
~ # vmkfstools -q /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Windows2003/Windows2003_2.vmdk
Disk /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Windows2003/Windows2003_2.vmdk is a Non-passthrough Raw Device Mapping
Maps to: vml.020003000060060e801046b96004f2bf4600000017444636303046
~ # vmkfstools -q /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Linux/Linux_1.vmdk
Disk /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Linux/Linux_1.vmdk is a Non-passthrough Raw Device Mapping
Maps to: vml.020005000060060e801046b96004f2bf4600000019444636303046
~ # vmkfstools -q /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Solaris10/Solaris10_1.vmdk
Disk /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Solaris10/Solaris10_1.vmdk is a Passthrough Raw Device Mapping
Maps to: vml.020004000060060e801046b96004f2bf4600000018444636303046
~ #
----
+
[NOTE]
====
A passagem é RDM com o físico (RDMP), e o nonpassthrough é RDM com o virtual (RDMV). As VMs com RDMs virtuais e cópias Snapshot da VM serão interrompidas após a migração devido ao VM Snapshot delta vmdk apontando para um RDM que tenha um ID naa obsoleto. Portanto, antes da migração, peça ao cliente para remover todas as cópias Snapshot de tais VMs. Clique com o botão direito do rato em VM e clique no botão Snapshot --> Snapshot Manager Delete All (Eliminar tudo). Consulte o NetApp KB 3013935 para obter detalhes sobre o bloqueio acelerado por hardware para VMware no armazenamento NetApp.

====
. Identificar o mapeamento de dispositivos LUN naa para RDM.
+
[listing]
----
~ # esxcfg-scsidevs -u | grep vml.020002000060060e801046b96004f2bf4600000016444636303046
naa.60060e801046b96004f2bf4600000016                            vml.020002000060060e801046b96004f2bf4600000016444636303046
~ # esxcfg-scsidevs -u | grep vml.020003000060060e801046b96004f2bf4600000017444636303046
naa.60060e801046b96004f2bf4600000017                            vml.020003000060060e801046b96004f2bf4600000017444636303046
~ # esxcfg-scsidevs -u | grep vml.020005000060060e801046b96004f2bf4600000019444636303046
naa.60060e801046b96004f2bf4600000019                            vml.020005000060060e801046b96004f2bf4600000019444636303046
~ # esxcfg-scsidevs -u | grep vml.020004000060060e801046b96004f2bf4600000018444636303046
naa.60060e801046b96004f2bf4600000018                            vml.020004000060060e801046b96004f2bf4600000018444636303046
~ #
----
. Determine a configuração da máquina virtual: `esxcli storage filesystem list | grep VMFS`
+
[listing]
----
/vmfs/volumes/538400f6-3486df59-52e5-00262d04d700  BootLun_datastore  538400f6-3486df59-52e5-00262d04d700     true  VMFS-5  13421772800  12486443008
/vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700  VM_datastore       53843dea-5449e4f7-88e0-00262d04d700     true  VMFS-5  42681237504   6208618496
~ #
----
. Registre o UUID do datastore.
. Faça uma cópia `/etc/vmware/hostd/vmInventory.xml` e anote o conteúdo do arquivo e do caminho de configuração vmx.
+
[listing]
----
~ # cp /etc/vmware/hostd/vmInventory.xml /etc/vmware/hostd/vmInventory.xml.bef_mig
~ # cat /etc/vmware/hostd/vmInventory.xml
<ConfigRoot>
  <ConfigEntry id="0001">
    <objID>2</objID>
    <vmxCfgPath>/vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Windows2003/Windows2003.vmx</vmxCfgPath>
  </ConfigEntry>
  <ConfigEntry id="0004">
    <objID>5</objID>
    <vmxCfgPath>/vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Linux/Linux.vmx</vmxCfgPath>
  </ConfigEntry>
  <ConfigEntry id="0005">
    <objID>6</objID>
    <vmxCfgPath>/vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Solaris10/Solaris10.vmx</vmxCfgPath>
  </ConfigEntry>
</ConfigRoot>
----
. Identifique os discos rígidos da máquina virtual.
+
Esta informação é necessária após a migração para adicionar os dispositivos RDM removidos em ordem.

+
[listing]
----
~ # grep fileName /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Windows2003/Windows2003.vmx
scsi0:0.fileName = "Windows2003.vmdk"
scsi0:1.fileName = "Windows2003_1.vmdk"
scsi0:2.fileName = "Windows2003_2.vmdk"
~ # grep fileName /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Linux/Linux.vmx
scsi0:0.fileName = "Linux.vmdk"
scsi0:1.fileName = "Linux_1.vmdk"
~ # grep fileName /vmfs/volumes/53843dea-5449e4f7-88e0-00262d04d700/Solaris10/Solaris10.vmx
scsi0:0.fileName = "Solaris10.vmdk"
scsi0:1.fileName = "Solaris10_1.vmdk"
~ #
----
. Determine o dispositivo RDM, o mapeamento da máquina virtual e o modo de compatibilidade.
. Usando as informações anteriores, observe o mapeamento RDM para o dispositivo, máquina virtual, modo de compatibilidade e ordem.
+
Você precisará dessas informações mais tarde, ao adicionar dispositivos RDM à VM.

+
[listing]
----
Virtual Machine -> Hardware -> NAA -> Compatibility mode
Windows2003 VM -> scsi0:1.fileName = "Windows2003_1.vmdk" -> naa.60060e801046b96004f2bf4600000016
-> RDM Physical
Windows2003 VM -> scsi0:2.fileName = "Windows2003_2.vmdk" -> naa.60060e801046b96004f2bf4600000017
-> RDM Virtual
Linux VM -> scsi0:1.fileName = “Linux_1.vmdk” -> naa.60060e801046b96004f2bf4600000019 -> RDM Virtual
Solaris10 VM -> scsi0:1.fileName = “Solaris10_1.vmdk” -> naa.60060e801046b96004f2bf4600000018 -> RDM Physical
----
. Determine a configuração multipath.
. Obtenha configurações de multipath para seu armazenamento no vSphere Client:
+
.. Selecione um host ESX ou ESXi no vSphere Client e clique na guia Configuration (Configuração).
.. Clique em *armazenamento*.
.. Selecione um datastore ou LUN mapeado.
.. Clique em *Propriedades*.
.. Na caixa de diálogo Propriedades, selecione a extensão desejada, se necessário.
.. Clique em *dispositivo de extensão* > *Gerenciar caminhos* e obtenha os caminhos na caixa de diálogo Gerenciar caminho.
+
image::../media/esxi_host_3.png[Caminhos dos dispositivos de armazenamento vSphere]



. Obtenha informações de multipathing LUN a partir da linha de comando do host ESXi:
+
.. Faça login no console do host ESXi.
.. Correr  `esxcli storage nmp device list` para obter informações de múltiplos caminhos.
+
[listing]
----
# esxcli storage nmp device list
naa.60060e801046b96004f2bf4600000014
   Device Display Name: HITACHI Fibre Channel Disk (naa.60060e801046b96004f2bf4600000014)
   Storage Array Type: VMW_SATP_DEFAULT_AA
   Storage Array Type Device Config: SATP VMW_SATP_DEFAULT_AA does not support device configuration.
   Path Selection Policy: VMW_PSP_RR
   Path Selection Policy Device Config: {policy=rr,iops=1000,bytes=10485760,useANO=0; lastPathIndex=3: NumIOsPending=0,numBytesPending=0}
   Path Selection Policy Device Custom Config:
   Working Paths: vmhba2:C0:T1:L0, vmhba2:C0:T0:L0, vmhba1:C0:T1:L0, vmhba1:C0:T0:L0
   Is Local SAS Device: false
   Is Boot USB Device: false

naa.60060e801046b96004f2bf4600000015
   Device Display Name: HITACHI Fibre Channel Disk (naa.60060e801046b96004f2bf4600000015)
   Storage Array Type: VMW_SATP_DEFAULT_AA
   Storage Array Type Device Config: SATP VMW_SATP_DEFAULT_AA does not support device configuration.
   Path Selection Policy: VMW_PSP_RR
   Path Selection Policy Device Config: {policy=rr,iops=1000,bytes=10485760,useANO=0; lastPathIndex=0: NumIOsPending=0,numBytesPending=0}
   Path Selection Policy Device Custom Config:
   Working Paths: vmhba2:C0:T1:L1, vmhba2:C0:T0:L1, vmhba1:C0:T1:L1, vmhba1:C0:T0:L1
   Is Local SAS Device: false
   Is Boot USB Device: false

naa.60060e801046b96004f2bf4600000016
   Device Display Name: HITACHI Fibre Channel Disk (naa.60060e801046b96004f2bf4600000016)
   Storage Array Type: VMW_SATP_DEFAULT_AA
   Storage Array Type Device Config: SATP VMW_SATP_DEFAULT_AA does not support device configuration.
   Path Selection Policy: VMW_PSP_RR
   Path Selection Policy Device Config: {policy=rr,iops=1000,bytes=10485760,useANO=0; lastPathIndex=1: NumIOsPending=0,numBytesPending=0}
   Path Selection Policy Device Custom Config:
   Working Paths: vmhba2:C0:T1:L2, vmhba2:C0:T0:L2, vmhba1:C0:T1:L2, vmhba1:C0:T0:L2
   Is Local SAS Device: false
   Is Boot USB Device: false

naa.60060e801046b96004f2bf4600000017
   Device Display Name: HITACHI Fibre Channel Disk (naa.60060e801046b96004f2bf4600000017)
   Storage Array Type: VMW_SATP_DEFAULT_AA
   Storage Array Type Device Config: SATP VMW_SATP_DEFAULT_AA does not support device configuration.
   Path Selection Policy: VMW_PSP_RR
   Path Selection Policy Device Config: {policy=rr,iops=1000,bytes=10485760,useANO=0; lastPathIndex=1: NumIOsPending=0,numBytesPending=0}
   Path Selection Policy Device Custom Config:
   Working Paths: vmhba2:C0:T1:L3, vmhba2:C0:T0:L3, vmhba1:C0:T1:L3, vmhba1:C0:T0:L3
   Is Local SAS Device: false
   Is Boot USB Device: false

naa.60060e801046b96004f2bf4600000018
   Device Display Name: HITACHI Fibre Channel Disk (naa.60060e801046b96004f2bf4600000018)
   Storage Array Type: VMW_SATP_DEFAULT_AA
   Storage Array Type Device Config: SATP VMW_SATP_DEFAULT_AA does not support device configuration.
   Path Selection Policy: VMW_PSP_RR
   Path Selection Policy Device Config: {policy=rr,iops=1000,bytes=10485760,useANO=0; lastPathIndex=1: NumIOsPending=0,numBytesPending=0}
   Path Selection Policy Device Custom Config:
   Working Paths: vmhba2:C0:T1:L4, vmhba2:C0:T0:L4, vmhba1:C0:T1:L4, vmhba1:C0:T0:L4
   Is Local SAS Device: false
   Is Boot USB Device: false

naa.60060e801046b96004f2bf4600000019
   Device Display Name: HITACHI Fibre Channel Disk (naa.60060e801046b96004f2bf4600000019)
   Storage Array Type: VMW_SATP_DEFAULT_AA
   Storage Array Type Device Config: SATP VMW_SATP_DEFAULT_AA does not support device configuration.
   Path Selection Policy: VMW_PSP_RR
   Path Selection Policy Device Config: {policy=rr,iops=1000,bytes=10485760,useANO=0; lastPathIndex=1: NumIOsPending=0,numBytesPending=0}
   Path Selection Policy Device Custom Config:
   Working Paths: vmhba2:C0:T1:L5, vmhba2:C0:T0:L5, vmhba1:C0:T1:L5, vmhba1:C0:T0:L5
   Is Local SAS Device: false
   Is Boot USB Device: false
----




.O que vem a seguir?
link:prepare-foreign-lun-offline.html["Preparar os LUNs do array de armazenamento externo para migração offline do FLI"] .
